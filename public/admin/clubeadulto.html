<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Clube Adulto & NSFW247 Scraper - Painel Administrativo OnlySuper">
    <title>Clube Adulto - OnlySuper Admin</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS Principal -->
    <link rel="stylesheet" href="/admin/assets/css/main.css">
    
    <style>
        .site-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .site-card {
            background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
            border: 2px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            cursor: pointer;
            transition: all var(--transition-base);
            text-align: center;
        }

        .site-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-300);
        }

        .site-card.active {
            border-color: var(--primary-500);
            background: linear-gradient(135deg, var(--primary-50), var(--primary-100));
        }

        .site-icon {
            font-size: 48px;
            margin-bottom: var(--space-3);
        }

        .site-name {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }

        .site-url {
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-3);
        }

        .log-container {
            background: var(--gray-900);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            max-height: 400px;
            overflow-y: auto;
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            color: #00ff00;
            margin-top: var(--space-4);
        }

        .log-entry {
            margin-bottom: var(--space-2);
            line-height: 1.5;
        }

        .log-entry.error {
            color: #ff4444;
        }

        .log-entry.success {
            color: #00ff00;
        }

        .log-entry.info {
            color: #00bfff;
        }

        .progress-container {
            margin-top: var(--space-4);
        }

        .progress-bar-wrapper {
            background: var(--gray-200);
            border-radius: var(--radius-full);
            height: 24px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, var(--primary-500), var(--secondary-500));
            height: 100%;
            transition: width var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-inverse);
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar ser√° injetada via JavaScript -->
        
        <!-- Conte√∫do Principal -->
        <main class="main-content">
            <!-- Header -->
            <header class="main-header">
                <div class="header-left">
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <span>‚ò∞</span>
                    </button>
                    <div>
                        <h1 class="page-title">üåü Clube Adulto & NSFW247</h1>
                        <p class="page-subtitle">Sistema de coleta de modelos e v√≠deos</p>
                    </div>
                </div>
                <div class="header-right">
                    <div class="header-actions">
                        <button class="header-btn" onclick="location.reload()" title="Atualizar">
                            <span>üîÑ</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Container de Conte√∫do -->
            <div class="content-container">
                <!-- Seletor de Site -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üåê Selecionar Site</h3>
                    </div>
                    <div class="card-body">
                        <div class="site-selector">
                            <div class="site-card" id="site-nsfw247" onclick="selectSite('nsfw247')">
                                <div class="site-icon">üî•</div>
                                <div class="site-name">NSFW247</div>
                                <div class="site-url">nsfw247.to</div>
                            </div>
                            <div class="site-card" id="site-clubeadulto" onclick="selectSite('clubeadulto')">
                                <div class="site-icon">üîû</div>
                                <div class="site-name">Clube Adulto</div>
                                <div class="site-url">clubeadulto.com</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controles de Scraping -->
                <div class="card" id="controls-card" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">üéÆ Controles de Scraping</h3>
                    </div>
                    <div class="card-body">
                        <div class="controls-grid">
                            <button class="btn btn-primary" onclick="scrapeModels()" id="btn-models">
                                <span>üë•</span>
                                <span>Scrape Modelos</span>
                            </button>
                            <button class="btn btn-success" onclick="scrapeVideos()" id="btn-videos">
                                <span>üé¨</span>
                                <span>Scrape V√≠deos</span>
                            </button>
                            <button class="btn btn-warning" onclick="scrapeVideoDetails()" id="btn-details">
                                <span>üé•</span>
                                <span>Scrape Detalhes</span>
                            </button>
                            <button class="btn btn-danger" onclick="stopScraping()" id="btn-stop" style="display: none;">
                                <span>‚õî</span>
                                <span>Parar</span>
                            </button>
                        </div>

                        <!-- Barra de Progresso -->
                        <div class="progress-container" id="progress-container" style="display: none;">
                            <div class="progress-bar-wrapper">
                                <div class="progress-bar-fill" id="progress-fill">0%</div>
                            </div>
                        </div>

                        <!-- Logs -->
                        <div class="log-container" id="logs"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript Core -->
    <script src="/admin/assets/js/admin-core.js"></script>
    
    <!-- JavaScript da P√°gina -->
    <script>
        let currentSite = null;
        let isRunning = false;

        function selectSite(site) {
            currentSite = site;
            
            // Atualizar UI
            document.querySelectorAll('.site-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementById(`site-${site}`).classList.add('active');
            
            // Mostrar controles
            document.getElementById('controls-card').style.display = 'block';
            
            addLog(`Site selecionado: ${site.toUpperCase()}`, 'info');
        }

        async function scrapeModels() {
            if (!currentSite) {
                adminCore.showNotification('Selecione um site primeiro', 'warning');
                return;
            }

            if (isRunning) {
                adminCore.showNotification('J√° existe um scraping em andamento nesta p√°gina', 'warning');
                return;
            }

            try {
                isRunning = true;
                updateButtons(true);
                showProgress(0);
                addLog('Iniciando scraping de modelos...', 'info');

                if (currentSite === 'clubeadulto') {
                    // Clube Adulto: verificar status e usar POST
                    const statusResponse = await fetch('/api/clubeadulto/scraping/models/status', {
                        credentials: 'include'
                    });

                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        if (statusData.status?.isRunning) {
                            addLog('‚ö†Ô∏è Scraping de modelos j√° est√° em execu√ß√£o no servidor', 'info');
                            addLog(`Progresso: ${statusData.status.progress || 0}%`, 'info');
                            adminCore.showNotification('Scraping j√° est√° em execu√ß√£o. Aguarde a conclus√£o.', 'warning');
                            isRunning = false;
                            updateButtons(false);
                            return;
                        }
                    }

                    const response = await fetch('/api/clubeadulto/scraping/models', {
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorData;
                        try {
                            errorData = JSON.parse(errorText);
                        } catch {
                            throw new Error(`Erro ${response.status}: ${errorText}`);
                        }
                        throw new Error(errorData.error || errorData.message || 'Erro desconhecido');
                    }

                    const data = await response.json();
                    if (data.success) {
                        addLog(`‚úì Scraping de modelos iniciado!`, 'success');
                        adminCore.showNotification('Scraping de modelos iniciado!', 'success');
                        startProgressPolling('models');
                    } else {
                        throw new Error(data.error || 'Erro desconhecido');
                    }
                } else {
                    // NSFW247: usar SSE (Server-Sent Events) com GET
                    addLog('‚úì Conectando ao stream do NSFW247...', 'info');
                    adminCore.showNotification('Scraping de modelos iniciado!', 'success');
                    
                    const eventSource = new EventSource('/api/nsfw247/scrape-models-stream');
                    
                    eventSource.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        if (data.log) {
                            addLog(data.log, 'info');
                        }
                        if (data.progress) {
                            showProgress(data.progress);
                        }
                    };
                    
                    eventSource.addEventListener('complete', (event) => {
                        const data = JSON.parse(event.data);
                        addLog(`‚úÖ Scraping conclu√≠do! ${data.totalModels || 0} modelos coletados.`, 'success');
                        adminCore.showNotification('Scraping conclu√≠do!', 'success');
                        eventSource.close();
                        isRunning = false;
                        updateButtons(false);
                        hideProgress();
                    });
                    
                    eventSource.onerror = (error) => {
                        addLog('‚úó Erro na conex√£o com o stream', 'error');
                        eventSource.close();
                        isRunning = false;
                        updateButtons(false);
                        hideProgress();
                    };
                }
            } catch (error) {
                addLog(`‚úó Erro: ${error.message}`, 'error');
                adminCore.showNotification(error.message, 'error');
                isRunning = false;
                updateButtons(false);
                hideProgress();
            }
        }

        async function scrapeVideos() {
            if (!currentSite) {
                adminCore.showNotification('Selecione um site primeiro', 'warning');
                return;
            }

            if (isRunning) {
                adminCore.showNotification('J√° existe um scraping em andamento nesta p√°gina', 'warning');
                return;
            }

            try {
                isRunning = true;
                updateButtons(true);
                showProgress(0);
                addLog('Iniciando scraping de v√≠deos...', 'info');

                if (currentSite === 'clubeadulto') {
                    // Clube Adulto: verificar status e usar POST
                    const statusResponse = await fetch('/api/clubeadulto/scraping/videos/status', {
                        credentials: 'include'
                    });

                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        if (statusData.status?.isRunning) {
                            addLog('‚ö†Ô∏è Scraping de v√≠deos j√° est√° em execu√ß√£o no servidor', 'info');
                            addLog(`Progresso: ${statusData.status.progress || 0}%`, 'info');
                            adminCore.showNotification('Scraping j√° est√° em execu√ß√£o. Aguarde a conclus√£o.', 'warning');
                            isRunning = false;
                            updateButtons(false);
                            return;
                        }
                    }

                    const response = await fetch('/api/clubeadulto/scraping/videos', {
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorData;
                        try {
                            errorData = JSON.parse(errorText);
                        } catch {
                            throw new Error(`Erro ${response.status}: ${errorText}`);
                        }
                        throw new Error(errorData.error || errorData.message || 'Erro desconhecido');
                    }

                    const data = await response.json();
                    if (data.success) {
                        const modelsCount = data.modelsCount || 0;
                        addLog(`‚úì Scraping iniciado! Processando ${modelsCount} modelos...`, 'success');
                        adminCore.showNotification('Scraping de v√≠deos iniciado!', 'success');
                        startProgressPolling('videos');
                    } else {
                        throw new Error(data.error || 'Erro desconhecido');
                    }
                } else {
                    // NSFW247: usar SSE (Server-Sent Events) com GET
                    addLog('‚úì Conectando ao stream do NSFW247...', 'info');
                    adminCore.showNotification('Scraping de v√≠deos iniciado!', 'success');
                    
                    const eventSource = new EventSource('/api/nsfw247/scrape-videos-stream');
                    
                    eventSource.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        if (data.log) {
                            addLog(data.log, 'info');
                        }
                        if (data.progress) {
                            showProgress(data.progress);
                        }
                    };
                    
                    eventSource.addEventListener('complete', (event) => {
                        const data = JSON.parse(event.data);
                        addLog(`‚úÖ Scraping conclu√≠do! ${data.totalVideos || 0} v√≠deos coletados.`, 'success');
                        adminCore.showNotification('Scraping conclu√≠do!', 'success');
                        eventSource.close();
                        isRunning = false;
                        updateButtons(false);
                        hideProgress();
                    });
                    
                    eventSource.onerror = (error) => {
                        addLog('‚úó Erro na conex√£o com o stream', 'error');
                        eventSource.close();
                        isRunning = false;
                        updateButtons(false);
                        hideProgress();
                    };
                }
            } catch (error) {
                addLog(`‚úó Erro: ${error.message}`, 'error');
                adminCore.showNotification(error.message, 'error');
                isRunning = false;
                updateButtons(false);
                hideProgress();
            }
        }

        async function scrapeVideoDetails() {
            if (!currentSite) {
                adminCore.showNotification('Selecione um site primeiro', 'warning');
                return;
            }

            if (isRunning) {
                adminCore.showNotification('J√° existe um scraping em andamento nesta p√°gina', 'warning');
                return;
            }

            try {
                isRunning = true;
                updateButtons(true);
                showProgress(0);
                addLog('Iniciando scraping de detalhes dos v√≠deos...', 'info');

                if (currentSite === 'clubeadulto') {
                    // Clube Adulto: verificar status e usar POST
                    const statusResponse = await fetch('/api/clubeadulto/scraping/video-details/status', {
                        credentials: 'include'
                    });

                    if (statusResponse.ok) {
                        const statusData = await statusResponse.json();
                        if (statusData.status?.isRunning) {
                            addLog('‚ö†Ô∏è Scraping de detalhes j√° est√° em execu√ß√£o no servidor', 'info');
                            addLog(`Progresso: ${statusData.status.progress || 0}%`, 'info');
                            adminCore.showNotification('Scraping j√° est√° em execu√ß√£o. Aguarde a conclus√£o.', 'warning');
                            isRunning = false;
                            updateButtons(false);
                            return;
                        }
                    }

                    const response = await fetch('/api/clubeadulto/scraping/video-details', {
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorData;
                        try {
                            errorData = JSON.parse(errorText);
                        } catch {
                            throw new Error(`Erro ${response.status}: ${errorText}`);
                        }
                        throw new Error(errorData.error || errorData.message || 'Erro desconhecido');
                    }

                    const data = await response.json();
                    if (data.success) {
                        addLog(`‚úì Scraping de detalhes iniciado!`, 'success');
                        adminCore.showNotification('Scraping de detalhes iniciado!', 'success');
                        startProgressPolling('video-details');
                    } else {
                        throw new Error(data.error || 'Erro desconhecido');
                    }
                } else {
                    // NSFW247: usar SSE (Server-Sent Events) com GET
                    addLog('‚úì Conectando ao stream do NSFW247...', 'info');
                    adminCore.showNotification('Scraping de detalhes iniciado!', 'success');
                    
                    const eventSource = new EventSource('/api/nsfw247/scrape-details-stream');
                    
                    eventSource.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        if (data.log) {
                            addLog(data.log, 'info');
                        }
                        if (data.progress) {
                            showProgress(data.progress);
                        }
                    };
                    
                    eventSource.addEventListener('complete', (event) => {
                        const data = JSON.parse(event.data);
                        addLog(`‚úÖ Scraping conclu√≠do! ${data.successCount || 0} v√≠deos atualizados.`, 'success');
                        adminCore.showNotification('Scraping conclu√≠do!', 'success');
                        eventSource.close();
                        isRunning = false;
                        updateButtons(false);
                        hideProgress();
                    });
                    
                    eventSource.onerror = (error) => {
                        addLog('‚úó Erro na conex√£o com o stream', 'error');
                        eventSource.close();
                        isRunning = false;
                        updateButtons(false);
                        hideProgress();
                    };
                }
            } catch (error) {
                addLog(`‚úó Erro: ${error.message}`, 'error');
                adminCore.showNotification(error.message, 'error');
                isRunning = false;
                updateButtons(false);
                hideProgress();
            }
        }

        function stopScraping() {
            isRunning = false;
            updateButtons(false);
            hideProgress();
            addLog('Scraping interrompido pelo usu√°rio', 'info');
            adminCore.showNotification('Scraping interrompido', 'info');
        }

        function updateButtons(running) {
            document.getElementById('btn-models').disabled = running;
            document.getElementById('btn-videos').disabled = running;
            document.getElementById('btn-details').disabled = running;
            document.getElementById('btn-stop').style.display = running ? 'block' : 'none';
        }

        function showProgress(percent) {
            const container = document.getElementById('progress-container');
            const fill = document.getElementById('progress-fill');
            container.style.display = 'block';
            fill.style.width = percent + '%';
            fill.textContent = percent + '%';
        }

        function hideProgress() {
            document.getElementById('progress-container').style.display = 'none';
        }

        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            entry.textContent = `[${timestamp}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        let progressInterval = null;

        async function startProgressPolling(type) {
            // Limpar polling anterior se existir
            if (progressInterval) {
                clearInterval(progressInterval);
            }

            // Polling a cada 2 segundos
            progressInterval = setInterval(async () => {
                try {
                    const statusEndpoint = currentSite === 'clubeadulto' 
                        ? `/api/clubeadulto/scraping/${type}/status`
                        : `/api/nsfw247/scraping/${type}/status`;

                    const response = await fetch(statusEndpoint, {
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const status = data.status;

                        if (status.isRunning) {
                            // Atualizar progresso
                            const progress = Math.round((status.processed / status.total) * 100) || 0;
                            showProgress(progress);
                            
                            if (status.currentModel) {
                                addLog(`üìç Processando: ${status.currentModel} [${status.processed}/${status.total}]`, 'info');
                            }
                        } else {
                            // Scraping conclu√≠do
                            clearInterval(progressInterval);
                            progressInterval = null;
                            
                            const totalVideos = status.totalVideos || 0;
                            addLog(`‚úÖ Scraping conclu√≠do! ${totalVideos} v√≠deos coletados no total.`, 'success');
                            adminCore.showNotification(`Scraping conclu√≠do! ${totalVideos} v√≠deos coletados.`, 'success');
                            
                            isRunning = false;
                            updateButtons(false);
                            hideProgress();
                        }
                    }
                } catch (error) {
                    console.error('Erro no polling:', error);
                }
            }, 2000);
        }

        // Adicionar log inicial
        addLog('Sistema pronto. Selecione um site para come√ßar.', 'info');
    </script>
</body>
</html>
